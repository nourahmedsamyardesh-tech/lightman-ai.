<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Man Ultra</title>
    <style>
        body { background: #eef2f3; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .bot-msg { background: #fff; padding: 15px; border-radius: 18px 18px 18px 2px; align-self: flex-start; max-width: 85%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: #222; }
        .user-msg { background: #007bff; color: #fff; padding: 15px; border-radius: 18px 18px 2px 18px; align-self: flex-end; max-width: 85%; }
        .controls { background: #fff; padding: 15px; border-top: 1px solid #ddd; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        select { padding: 8px; border-radius: 10px; border: 1px solid #ddd; background: #f9f9f9; font-size: 12px; margin-bottom: 10px; width: 100%; }
        input { flex: 1; border: 1px solid #ddd; border-radius: 25px; padding: 12px 20px; outline: none; }
        button { border: none; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .call-btn { width: 50px; height: 50px; border-radius: 50%; background: #28a745; color: white; font-size: 24px; }
        .send-btn { background: #007bff; color: white; border-radius: 25px; padding: 0 20px; height: 45px; }
        img { width: 100%; border-radius: 12px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="chat-box"></div>
    <div class="controls">
        <select id="voice-select"><option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª...</option></select>
        
        <div class="input-row">
            <input type="text" id="user-input" placeholder="ØªØ­Ø¯Ø« Ù…Ø¹ Ù„Ø§ÙŠØª Ù…Ø§Ù†...">
            <button class="call-btn" id="call-btn" onclick="toggleCall()">ðŸ“ž</button>
            <button class="send-btn" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script>
        const box = document.getElementById('chat-box');
        const input = document.getElementById('user-input');
        const voiceSelect = document.getElementById('voice-select');
        let isCalling = false;
        let voices = [];

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ (Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£Ùˆ ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            voiceSelect.innerHTML = voices
                .filter(v => v.lang.includes('ar') || v.lang.includes('en'))
                .map((v, i) => `<option value="${i}">${v.name} (${v.lang})</option>`).join('');
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ar-SA';
        recognition.continuous = true;

        function toggleCall() {
            if (!isCalling) {
                recognition.start();
                document.getElementById('call-btn').style.background = 'red';
                document.getElementById('call-btn').innerText = 'â¹';
                isCalling = true;
            } else {
                recognition.stop();
                document.getElementById('call-btn').style.background = '#28a745';
                document.getElementById('call-btn').innerText = 'ðŸ“ž';
                isCalling = false;
            }
        }

        recognition.onresult = (event) => {
            const text = event.results[event.results.length - 1][0].transcript;
            input.value = text;
            send();
        };

        async function send() {
            const msg = input.value.trim();
            if (!msg) return;
            box.innerHTML += `<div class="user-msg">${msg}</div>`;
            input.value = '';
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg })
            });
            const data = await response.json();
            
            let htmlReply = `<div class="bot-msg">`;
            if (data.reply.includes("IMAGE_URL:")) {
                const parts = data.reply.split("IMAGE_URL:");
                htmlReply += `<img src="${parts[1].trim()}"><br>` + parts[0];
            } else {
                htmlReply += data.reply;
            }
            htmlReply += `</div>`;
            box.innerHTML += htmlReply;
            box.scrollTop = box.scrollHeight;

            // Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø±
            const utterance = new SpeechSynthesisUtterance(data.reply.split("IMAGE_URL:")[0]);
            if (voices[voiceSelect.value]) utterance.voice = voices[voiceSelect.value];
            utterance.lang = 'ar-SA';
            utterance.rate = 0.9; // Ø³Ø±Ø¹Ø© Ù‡Ø§Ø¯Ø¦Ø© ÙˆØ·Ø¨ÙŠØ¹ÙŠØ©
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
